pipeline {
	agent any
	stages {
		stage('Lint html') {
			steps {
					sh '''
					    tidy deploy-bg/*.html
					'''
			}
		}
		stage('Build Docker Image') {
			steps {
				withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'Jenkins', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD']]){
					sh '''
						docker build -t fran6cu/udacity_capstone -f deploy-bg/Dockerfile .
					'''
				}
			}
		}
		stage('Push Docker Image to Dockerhub') {
			steps {
				withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'Jenkins', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD']]){
					sh '''
						docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
						docker push fran6cu/udacity_capstone
					'''
				}
			}
		}

		stage('Set kubectl config') {
			steps {
				withAWS(region:'us-east-1', credentials:'Jenkins') {
					sh '''
						kubectl config use-context arn:aws:eks:us-east-1:474880089665:cluster/udacity-cluster-eks
					'''
				}
			}
		}
		stage('Blue') {
			steps {
				withAWS(region:'us-east-1', credentials:'Jenkins') {
					sh '''
						kubectl apply -f deploy-bg/blue.controller.json
					'''
				}
			}
		}
		stage('Green') {
			steps {
				withAWS(region:'us-east-1', credentials:'Jenkins') {
					sh '''
						kubectl apply -f deploy-bg/green.controller.json
					'''
				}
			}
		}
		stage('Apply Blue') {
			steps {
				withAWS(region:'us-east-1', credentials:'Jenkins') {
					sh '''
						kubectl apply -f deploy-bg/blue.service.json
					'''
				}
			}
		}
		stage('Wait to redirect the traffic to the green service') {
            steps {
                input "Wait to redirect the traffic to the green service"
            }
        }
		stage('Apply the green service within cluster') {
			steps {
				withAWS(region:'us-east-1', credentials:'Jenkins') {
					sh '''
						kubectl apply -f deploy-bg/green.service.json
					'''
				}
			}
		}
	}
}
